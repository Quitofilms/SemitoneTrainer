<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Piano Semitone Trainer v3.1</title>
    <style>
        :root {
            --bg-color: #222;
            --text-color: #eee;
            --accent: #4CAF50; /* Green */
            --fail: #ff4444;    /* Red */
            --hint-color: #FF9800; /* Orange */
            --timed-color: #9C27B0; /* Purple */
            --highlight: #2196F3; /* Blue */
            --box-bg: #333;
            --timer-text: #ff4444;
            --neon-blue: #2196F3;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- PORTRAIT WARNING OVERLAY --- */
        #portrait-warning {
            display: none; /* Hidden by default, toggled by JS */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 9999; /* Highest priority */
            background-color: #000;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
            box-sizing: border-box;
        }

        #portrait-warning h2 {
            color: var(--fail);
            font-size: 2rem;
            margin-bottom: 20px;
            text-transform: uppercase;
        }

        #portrait-warning p {
            color: #fff;
            font-size: 1.2rem;
        }
        
        #rotate-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            display: block;
        }

        /* --- START SCREEN --- */
        #start-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2000; 
            background-color: #111; 
            background-image: url('https://swingdancent.com/startscreen.jpg');
            background-repeat: no-repeat;
            background-position: center center;
            background-attachment: fixed;
            background-size: cover;
            display: flex;
            justify-content: flex-end; 
            align-items: flex-end; 
            padding: 30px; 
            box-sizing: border-box;
        }

        /* --- TUTORIAL SCREEN --- */
        #tutorial-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1500; 
            background-color: rgba(0,0,0,0.95);
            display: none; 
            flex-direction: column;
            justify-content: center; 
            align-items: center; 
            padding: 10px; 
            box-sizing: border-box;
            text-align: center;
        }

        #tutorial-content {
            max-width: 600px;
            color: #fff;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px; 
        }
        
        #tutorial-content h2 {
            font-size: 1.5rem; 
            color: var(--neon-blue);
            margin: 0; 
            text-transform: uppercase;
            text-shadow: 0 0 10px var(--neon-blue);
        }

        .definition-text {
            font-size: 0.95rem; 
            color: #bbb;
            line-height: 1.3;
            background: rgba(255,255,255,0.05);
            padding: 8px 15px;
            border-radius: 8px;
            margin: 0;
        }

        #tutorial-content p.instructions {
            font-size: 1.0rem;
            line-height: 1.3;
            margin: 0;
            color: #ddd;
        }
        
        .important-note {
            color: var(--hint-color);
            font-weight: bold;
            display: block;
            margin-top: 5px;
            font-size: 0.9rem;
        }

        .big-btn {
            background: rgba(0, 0, 0, 0.6); 
            border: 3px solid var(--neon-blue);
            color: #fff;
            font-size: 1.2rem; 
            font-weight: 800;
            padding: 10px 30px; 
            border-radius: 12px;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 2px;
            box-shadow: 0 0 20px var(--neon-blue), inset 0 0 20px var(--neon-blue); 
            text-shadow: 0 0 10px var(--neon-blue);
            transition: transform 0.1s, box-shadow 0.1s;
            margin-top: 5px; 
        }
        .big-btn:active { transform: scale(0.95); }


        /* --- MAIN GAME --- */
        #game-container {
            display: none; 
            height: 100%;
            width: 100%;
            flex-direction: column;
        }

        /* --- TOP INTERFACE LAYOUT --- */
        #game-interface {
            flex: 4; 
            width: 100%;
            box-sizing: border-box;
            display: flex;
            flex-direction: row;
            justify-content: center; 
            align-items: center;     
            gap: 5px; 
            padding: 0 5px;          
        }

        .ui-box {
            background: var(--box-bg);
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.4);
            height: 65px; 
            display: flex;
            align-items: center;
            justify-content: center;
            box-sizing: border-box;
            white-space: nowrap;
        }

        /* BOX 1: Prompt */
        #prompt-box {
            padding: 0 10px; 
            flex-direction: column;
            line-height: 1.1;
            flex: 0 1 auto; 
        }
        #prompt-interval {
            display: block;
            font-size: 0.9rem;
            font-weight: bold;
            color: #fff;
            margin-bottom: 2px;
        }
        #prompt-note-line { 
            display: block;
            font-size: 1.0rem;
            font-weight: bold;
            color: #aaa; 
        }
        .highlight-note {
            color: var(--highlight);
            font-weight: 800;
            font-size: 1.2rem;
            margin-left: 3px;
        }

        /* BOX 2: Feedback */
        #feedback-box {
            padding: 0 8px; 
            flex-direction: column;
            flex: 0 1 auto; 
            min-width: 80px; 
        }
        #streak-display {
            font-size: 0.85rem;
            color: #aaa;
            font-weight: bold;
            margin-bottom: 3px;
        }
        .streak-high { color: var(--accent) !important; }
        #feedback {
            font-size: 1.0rem;
            font-weight: bold;
            opacity: 0; 
            transition: opacity 0.3s;
            height: 1.1rem; 
            line-height: 1.1rem;
        }

        /* BOX 3: Input Controls */
        #input-area {
            gap: 5px; 
            padding: 0 8px; 
            flex: 0 0 auto; 
        }
        input[type="text"] {
            font-size: 1.1rem;
            padding: 8px 0;
            width: 45px; 
            text-align: center;
            border-radius: 6px;
            border: 2px solid #555;
            background: #fff;
            color: #000;
            font-weight: bold;
        }
        input[type="text"]:focus { border-color: var(--accent); outline: none; }

        button {
            color: white;
            border: none;
            padding: 8px 10px; 
            font-size: 0.9rem; 
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 3px rgba(0,0,0,0.3);
            transition: all 0.1s;
            white-space: nowrap;
        }
        button:active { box-shadow: none; transform: translateY(3px); }
        
        #submit-btn { background-color: var(--accent); }
        #hint-btn { background-color: var(--hint-color); }
        #timed-btn { background-color: var(--timed-color); }
        #timer-display {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--timer-text);
            width: 30px; 
            text-align: center;
            display: none; 
        }

        /* --- PIANO --- */
        #piano-wrapper {
            flex: 6; 
            position: relative;
            background: #111;
            border-top: 5px solid #000;
            width: 100%;
            display: flex;
            justify-content: center;
            box-shadow: inset 0 10px 20px -10px #000;
        }
        .piano {
            position: relative;
            height: 100%;
            width: 100%; 
            max-width: 900px; 
            background: #000;
        }
        .key {
            position: absolute;
            box-sizing: border-box;
            border-radius: 0 0 6px 6px;
            pointer-events: none; 
            transition: background 0.2s, box-shadow 0.2s;
        }
        .key.white {
            height: 100%;
            background: linear-gradient(to bottom, #eee 0%, #fff 100%);
            border: 1px solid #bbb;
            border-top: none;
            z-index: 1;
            box-shadow: inset 0 -5px 8px rgba(0,0,0,0.1);
        }
        .key.black {
            height: 65%; 
            background: linear-gradient(to bottom, #333 0%, #000 100%);
            border: 2px solid #000;
            border-top: none;
            z-index: 10; 
            box-shadow: inset 0 -3px 5px rgba(255,255,255,0.2), 2px 4px 5px rgba(0,0,0,0.4);
        }
        .key.active-start {
            background: var(--highlight) !important;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.2) !important;
        }
        .key.black.active-start {
             background: linear-gradient(to bottom, #1565c0 0%, var(--highlight) 100%) !important;
             box-shadow: 0 0 15px var(--highlight) !important;
        }
        .key.correct-flash {
            background: var(--accent) !important;
            box-shadow: 0 0 20px var(--accent) !important;
            transition: none; 
        }
        .key.wrong-flash {
            background: var(--fail) !important;
            box-shadow: 0 0 20px var(--fail) !important;
            transition: none;
        }
        .key-label {
            position: absolute;
            bottom: 5px;
            left: 50%;
            transform: translateX(-50%);
            color: #777;
            font-size: 10px;
            font-weight: bold;
            pointer-events: none;
        }
    </style>
</head>
<body>

    <div id="portrait-warning">
        <span id="rotate-icon">â†»</span>
        <h2>Please Rotate</h2>
        <p>This game requires landscape mode.</p>
    </div>

    <div id="start-screen">
        <button id="start-btn" class="big-btn" onclick="attemptStart()">START</button>
    </div>

    <div id="tutorial-screen">
        <div id="tutorial-content">
            <h2>How To Play</h2>
            
            <div class="definition-text">
                A <strong>semitone</strong> is a key directly left or right.<br>
                A <strong>tone</strong> is two semitones left or right.
            </div>

            <p class="instructions">
                1. Calculate the target note from prompt.<br>
                2. Tap <strong>White Input Box</strong> to type answer.<br>
                3. Press <strong>Submit</strong>.
                <span class="important-note">Note: Piano is for visual reference only. Do not tap keys!</span>
            </p>
            <button class="big-btn" onclick="finishTutorial()">BEGIN</button>
        </div>
    </div>

    <div id="game-container">
        <div id="game-interface">
            <div id="prompt-box" class="ui-box">
                <span id="prompt-interval">Loading...</span>
                <span id="prompt-note-line"></span> 
            </div>
            
            <div id="feedback-box" class="ui-box">
                <div id="streak-display">Streak: 0</div>
                <div id="feedback">Correct!</div>
            </div>

            <div id="input-area" class="ui-box">
                <button id="timed-btn" onclick="toggleTimedMode()">Timed</button>
                <button id="hint-btn" onclick="showHint()">Hint</button>
                <span id="timer-display">5</span>
                <input type="text" id="userAnswer" placeholder="F#" autocomplete="off" autocorrect="off" autocapitalize="characters" spellcheck="false">
                <button id="submit-btn" onclick="checkAnswer()">Submit</button>
            </div>
        </div>
        
        <div id="piano-wrapper">
            <div class="piano" id="piano"></div>
        </div>
    </div>

<script>
    // --- Configuration ---
    const FULL_SCALE = [
        "C3", "C#3", "D3", "D#3", "E3", "F3", "F#3", "G3", "G#3", "A3", "A#3", "B3",
        "C4", "C#4", "D4", "D#4", "E4", "F4", "F#4", "G4"
    ];
    const TOTAL_WHITE_KEYS = FULL_SCALE.filter(note => !note.includes('#')).length; 
    const ENHARMONICS = { "DB": "C#", "EB": "D#", "GB": "F#", "AB": "G#", "BB": "A#", "E#": "F", "B#": "C", "CB": "B", "FB": "E" };

    let keysArray = [];
    let currentTargetNoteStr = "";
    let currentStartIndex = -1;
    let currentTargetIndex = -1;
    let streak = 0;
    
    let isTimedMode = false;
    let timerInterval = null;
    let timeLeft = 5; 
    let audioCtx;
    let gameStarted = false;
    
    const pianoEl = document.getElementById('piano');

    function initAudio() {
        if(!audioCtx) {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            audioCtx = new AudioContext();
        }
    }

    function playNote(noteIndex) {
        if (!audioCtx) return;
        const midiBase = 48; 
        const midiNum = midiBase + noteIndex;
        const freq = 440 * Math.pow(2, (midiNum - 69) / 12);
        const osc = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();
        osc.type = 'triangle'; 
        osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
        gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 1.0);
        osc.connect(gainNode);
        gainNode.connect(audioCtx.destination);
        osc.start();
        osc.stop(audioCtx.currentTime + 1.0);
    }

    // --- CONTINUOUS ORIENTATION CHECKER ---
    function checkOrientationLoop() {
        const warning = document.getElementById('portrait-warning');
        if (window.innerHeight > window.innerWidth) {
            // Portrait - Show warning overlay
            warning.style.display = 'flex';
        } else {
            // Landscape - Hide warning overlay
            warning.style.display = 'none';
        }
    }

    // Run this check immediately and on every resize
    window.addEventListener('load', checkOrientationLoop);
    window.addEventListener('resize', checkOrientationLoop);
    window.addEventListener('orientationchange', checkOrientationLoop);

    function attemptStart() {
        initAudio(); // User gesture required for audio
        showTutorial();
    }

    function showTutorial() {
        document.getElementById('start-screen').style.display = 'none';
        document.getElementById('tutorial-screen').style.display = 'flex';
    }

    function finishTutorial() {
        document.getElementById('tutorial-screen').style.display = 'none';
        document.getElementById('game-container').style.display = 'flex';
        gameStarted = true;
        initPiano();
        setTimeout(generateLevel, 100);
        window.addEventListener('resize', initPiano);
    }

    function initPiano() {
        pianoEl.innerHTML = '';
        keysArray = [];
        const whiteKeyWidthPct = 100 / TOTAL_WHITE_KEYS;
        const blackKeyWidthPct = whiteKeyWidthPct * 0.65; 
        let whiteKeyIndex = 0; 
        FULL_SCALE.forEach((noteStr) => {
            const isBlack = noteStr.includes('#');
            const noteNameBasic = noteStr.slice(0, -1); 
            const key = document.createElement('div');
            key.classList.add('key');
            key.classList.add(isBlack ? 'black' : 'white');
            key.dataset.note = noteStr;
            if (isBlack) {
                const leftPos = (whiteKeyIndex * whiteKeyWidthPct) - (blackKeyWidthPct / 2);
                key.style.width = `${blackKeyWidthPct}%`;
                key.style.left = `${leftPos}%`;
            } else {
                const leftPos = whiteKeyIndex * whiteKeyWidthPct;
                key.style.width = `${whiteKeyWidthPct}%`;
                key.style.left = `${leftPos}%`;
                if (noteNameBasic === 'C') {
                    const label = document.createElement('div');
                    label.className = 'key-label';
                    label.innerText = noteStr;
                    key.appendChild(label);
                }
                whiteKeyIndex++;
            }
            pianoEl.appendChild(key);
            keysArray.push({ element: key, noteStr: noteStr, noteNameBasic: noteNameBasic });
        });
    }

    function generateLevel() {
        document.getElementById('userAnswer').value = '';
        keysArray.forEach(k => {
            k.element.classList.remove('active-start');
            k.element.classList.remove('correct-flash');
            k.element.classList.remove('wrong-flash');
        });
        document.getElementById('userAnswer').blur(); 
        if (isTimedMode) resetTimer();
        const maxIdx = keysArray.length - 1;
        const useTones = Math.random() > 0.5;
        let distanceVal = 0;
        let distanceName = "";
        if (useTones) {
            const t = Math.floor(Math.random() * 2) + 1; 
            distanceVal = t * 2;
            distanceName = t + (t === 1 ? " Tone" : " Tones");
        } else {
            const s = Math.floor(Math.random() * 4) + 1; 
            distanceVal = s;
            distanceName = s + (s === 1 ? " Semitone" : " Semitones");
        }
        const direction = Math.random() > 0.5 ? 1 : -1; 
        const validStartIndices = [];
        for (let i = 0; i <= maxIdx; i++) {
             const potentialTarget = i + (distanceVal * direction);
             if (potentialTarget >= 0 && potentialTarget <= maxIdx) {
                 validStartIndices.push(i);
             }
        }
        const startKeyIdx = validStartIndices[Math.floor(Math.random() * validStartIndices.length)];
        const startKeyObj = keysArray[startKeyIdx];
        currentStartIndex = startKeyIdx;
        const targetIdx = startKeyIdx + (distanceVal * direction);
        currentTargetIndex = targetIdx; 
        currentTargetNoteStr = keysArray[targetIdx].noteNameBasic;
        const dirText = direction === 1 ? "Above" : "Below";
        
        document.getElementById('prompt-interval').innerText = `${distanceName}`;
        // CHANGED: Use noteNameBasic to remove octave from display
        document.getElementById('prompt-note-line').innerHTML = `${dirText} <span class="highlight-note">${startKeyObj.noteNameBasic}</span>`;

        playNote(currentStartIndex);
    }

    function showHint() {
        if (currentStartIndex !== -1) {
            const keyObj = keysArray[currentStartIndex];
            keyObj.element.classList.add('active-start');
            playNote(currentStartIndex); 
            setTimeout(() => {
                keyObj.element.classList.remove('active-start');
            }, 500);
        }
    }

    function toggleTimedMode() {
        const btn = document.getElementById('timed-btn');
        const hintBtn = document.getElementById('hint-btn');
        const timerDisplay = document.getElementById('timer-display');
        isTimedMode = !isTimedMode;
        if (isTimedMode) {
            btn.innerText = "Stop";
            btn.style.backgroundColor = "#ff4444"; 
            hintBtn.style.display = "none";
            timerDisplay.style.display = "inline-block";
            generateLevel(); 
        } else {
            btn.innerText = "Timed";
            btn.style.backgroundColor = "#9C27B0"; 
            hintBtn.style.display = "inline-block";
            timerDisplay.style.display = "none";
            clearInterval(timerInterval);
        }
    }

    function resetTimer() {
        clearInterval(timerInterval);
        timeLeft = 5; 
        document.getElementById('timer-display').innerText = timeLeft;
        timerInterval = setInterval(() => {
            timeLeft--;
            document.getElementById('timer-display').innerText = timeLeft;
            if (timeLeft <= 0) handleTimeout();
        }, 1000);
    }

    function handleTimeout() {
        clearInterval(timerInterval);
        resetStreak();
        showFeedback("Time's Up!", "#ff4444");
        if (currentTargetIndex !== -1) {
            keysArray[currentTargetIndex].element.classList.add('wrong-flash');
        }
        setTimeout(() => {
            generateLevel();
        }, 1500);
    }

    function checkAnswer() {
        const inputField = document.getElementById('userAnswer');
        let processedInput = inputField.value.trim().toUpperCase();
        if (!processedInput) return;
        processedInput = processedInput.replace(/[0-9]/g, '');
        if (ENHARMONICS[processedInput]) processedInput = ENHARMONICS[processedInput];
        if (processedInput === currentTargetNoteStr) {
            incrementStreak();
            showFeedback("Correct!", "#4CAF50");
            keysArray[currentTargetIndex].element.classList.add('correct-flash');
            playNote(currentTargetIndex);
            setTimeout(() => {
                generateLevel(); 
            }, 1200);
        } else {
            resetStreak();
            showFeedback(`Try Again!`, "#ff4444"); 
            keysArray[currentTargetIndex].element.classList.add('wrong-flash');
            inputField.value = ''; 
            inputField.focus();
            setTimeout(() => {
                keysArray[currentTargetIndex].element.classList.remove('wrong-flash');
                document.getElementById('feedback').style.opacity = 0;
            }, 1500);
        }
    }

    function incrementStreak() {
        streak++;
        updateStreakDisplay();
    }
    function resetStreak() {
        streak = 0;
        updateStreakDisplay();
    }
    function updateStreakDisplay() {
        const el = document.getElementById('streak-display');
        el.innerText = "Streak: " + streak;
        if(streak > 5) el.classList.add('streak-high');
        else el.classList.remove('streak-high');
    }

    function showFeedback(text, color) {
        const el = document.getElementById('feedback');
        el.innerText = text;
        el.style.color = color;
        el.style.opacity = 1;
    }

    document.getElementById('userAnswer').addEventListener("keyup", function(event) {
        if (event.key === "Enter") {
            event.preventDefault();
            checkAnswer();
        }
    });
</script>
</body>
</html>
